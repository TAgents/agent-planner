{
  "openapi": "3.0.0",
  "info": {
    "title": "Agent Planner API",
    "version": "1.0.0",
    "description": "A collaborative planning system for humans and AI agents",
    "contact": {
      "name": "API Support",
      "email": "support@example.com"
    },
    "license": {
      "name": "MIT",
      "url": "https://opensource.org/licenses/MIT"
    }
  },
  "servers": [
    {
      "url": "http://localhost:3000",
      "description": "Current environment"
    },
    {
      "url": "http://localhost:3000",
      "description": "Local development"
    },
    {
      "url": "https://api.agent-planner.com",
      "description": "Production"
    }
  ],
  "components": {
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "Supabase JWT token"
      },
      "apiKey": {
        "type": "apiKey",
        "in": "header",
        "name": "Authorization",
        "description": "API Key authentication (format: ApiKey <token>)"
      }
    },
    "responses": {
      "Unauthorized": {
        "description": "Authentication required",
        "content": {
          "application/json": {
            "schema": {
              "$ref": "#/components/schemas/Error"
            },
            "example": {
              "error": "Authentication required"
            }
          }
        }
      },
      "Forbidden": {
        "description": "Access denied",
        "content": {
          "application/json": {
            "schema": {
              "$ref": "#/components/schemas/Error"
            },
            "example": {
              "error": "You do not have permission to access this resource"
            }
          }
        }
      },
      "NotFound": {
        "description": "Resource not found",
        "content": {
          "application/json": {
            "schema": {
              "$ref": "#/components/schemas/Error"
            },
            "example": {
              "error": "Resource not found"
            }
          }
        }
      },
      "BadRequest": {
        "description": "Invalid request",
        "content": {
          "application/json": {
            "schema": {
              "$ref": "#/components/schemas/Error"
            },
            "example": {
              "error": "Invalid request parameters"
            }
          }
        }
      },
      "InternalError": {
        "description": "Internal server error",
        "content": {
          "application/json": {
            "schema": {
              "$ref": "#/components/schemas/Error"
            },
            "example": {
              "error": "An internal server error occurred"
            }
          }
        }
      }
    },
    "schemas": {
      "Activity": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid"
          },
          "type": {
            "type": "string",
            "enum": [
              "log",
              "comment"
            ]
          },
          "content": {
            "type": "string"
          },
          "activity_type": {
            "type": "string"
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "user": {
            "type": "object",
            "properties": {
              "id": {
                "type": "string"
              },
              "name": {
                "type": "string"
              },
              "email": {
                "type": "string"
              }
            }
          },
          "node": {
            "type": "object",
            "properties": {
              "id": {
                "type": "string"
              },
              "title": {
                "type": "string"
              },
              "node_type": {
                "type": "string"
              }
            }
          },
          "plan": {
            "type": "object",
            "properties": {
              "id": {
                "type": "string"
              },
              "title": {
                "type": "string"
              }
            }
          }
        }
      },
      "Artifact": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid"
          },
          "plan_node_id": {
            "type": "string",
            "format": "uuid"
          },
          "name": {
            "type": "string"
          },
          "content_type": {
            "type": "string"
          },
          "url": {
            "type": "string"
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "created_by": {
            "type": "string",
            "format": "uuid"
          },
          "metadata": {
            "type": "object"
          }
        }
      },
      "Node": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid"
          },
          "plan_id": {
            "type": "string",
            "format": "uuid"
          },
          "parent_id": {
            "type": "string",
            "format": "uuid",
            "nullable": true
          },
          "node_type": {
            "type": "string",
            "enum": [
              "root",
              "phase",
              "task",
              "milestone"
            ]
          },
          "title": {
            "type": "string"
          },
          "description": {
            "type": "string"
          },
          "status": {
            "type": "string",
            "enum": [
              "not_started",
              "in_progress",
              "completed",
              "blocked"
            ],
            "default": "not_started"
          },
          "order_index": {
            "type": "integer"
          },
          "due_date": {
            "type": "string",
            "format": "date-time",
            "nullable": true
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time"
          },
          "context": {
            "type": "string"
          },
          "agent_instructions": {
            "type": "string",
            "nullable": true
          },
          "acceptance_criteria": {
            "type": "string",
            "nullable": true
          },
          "metadata": {
            "type": "object"
          },
          "children": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/Node"
            }
          }
        },
        "required": [
          "title",
          "node_type"
        ]
      },
      "Plan": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid",
            "example": "123e4567-e89b-12d3-a456-426614174000"
          },
          "title": {
            "type": "string",
            "example": "Q1 Product Launch"
          },
          "description": {
            "type": "string",
            "example": "Complete product launch plan for Q1"
          },
          "status": {
            "type": "string",
            "enum": [
              "draft",
              "active",
              "completed",
              "archived"
            ],
            "default": "draft"
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time"
          },
          "metadata": {
            "type": "object",
            "additionalProperties": true
          },
          "owner_id": {
            "type": "string",
            "format": "uuid"
          }
        },
        "required": [
          "title"
        ]
      },
      "Token": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid"
          },
          "name": {
            "type": "string"
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "last_used": {
            "type": "string",
            "format": "date-time",
            "nullable": true
          },
          "permissions": {
            "type": "array",
            "items": {
              "type": "string",
              "enum": [
                "read",
                "write",
                "admin"
              ]
            }
          }
        }
      },
      "Comment": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid"
          },
          "plan_node_id": {
            "type": "string",
            "format": "uuid"
          },
          "user_id": {
            "type": "string",
            "format": "uuid"
          },
          "content": {
            "type": "string"
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time"
          },
          "comment_type": {
            "type": "string",
            "enum": [
              "human",
              "agent",
              "system"
            ]
          }
        }
      },
      "LogEntry": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid"
          },
          "plan_node_id": {
            "type": "string",
            "format": "uuid"
          },
          "user_id": {
            "type": "string",
            "format": "uuid"
          },
          "content": {
            "type": "string"
          },
          "log_type": {
            "type": "string",
            "enum": [
              "progress",
              "reasoning",
              "challenge",
              "decision"
            ]
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "metadata": {
            "type": "object"
          },
          "tags": {
            "type": "array",
            "items": {
              "type": "string"
            }
          }
        }
      },
      "ApiToken": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid"
          },
          "user_id": {
            "type": "string",
            "format": "uuid"
          },
          "name": {
            "type": "string"
          },
          "permissions": {
            "type": "array",
            "items": {
              "type": "string",
              "enum": [
                "read",
                "write",
                "admin"
              ]
            }
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "last_used": {
            "type": "string",
            "format": "date-time",
            "nullable": true
          },
          "revoked": {
            "type": "boolean",
            "default": false
          }
        }
      },
      "User": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid"
          },
          "email": {
            "type": "string",
            "format": "email"
          },
          "name": {
            "type": "string"
          },
          "organization": {
            "type": "string"
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "Error": {
        "type": "object",
        "properties": {
          "error": {
            "type": "string",
            "description": "Error message"
          },
          "details": {
            "type": "object",
            "description": "Additional error details"
          }
        }
      },
      "PaginatedResponse": {
        "type": "object",
        "properties": {
          "data": {
            "type": "array",
            "items": {
              "type": "object"
            }
          },
          "pagination": {
            "type": "object",
            "properties": {
              "page": {
                "type": "integer"
              },
              "limit": {
                "type": "integer"
              },
              "total": {
                "type": "integer"
              },
              "pages": {
                "type": "integer"
              }
            }
          }
        }
      }
    }
  },
  "tags": [
    {
      "name": "Authentication",
      "description": "User authentication and session management"
    },
    {
      "name": "Plans",
      "description": "Plan management operations"
    },
    {
      "name": "Nodes",
      "description": "Plan node operations"
    },
    {
      "name": "Artifacts",
      "description": "Artifact management"
    },
    {
      "name": "Activity",
      "description": "Activity tracking and logs"
    },
    {
      "name": "Search",
      "description": "Search operations"
    },
    {
      "name": "Tokens",
      "description": "API token management"
    },
    {
      "name": "Upload",
      "description": "File upload operations"
    },
    {
      "name": "Users",
      "description": "User management"
    },
    {
      "name": "Health",
      "description": "System health and status"
    },
    {
      "name": "Debug",
      "description": "Debug endpoints (not for production use)"
    },
    {
      "name": "API Tokens",
      "description": "API token management endpoints"
    },
    {
      "name": "User",
      "description": "User profile management"
    }
  ],
  "paths": {
    "/activity/feed": {
      "get": {
        "summary": "Get activity feed for the current user across all accessible plans",
        "tags": [
          "Activity"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "query",
            "name": "page",
            "schema": {
              "type": "integer",
              "default": 1
            },
            "description": "Page number"
          },
          {
            "in": "query",
            "name": "limit",
            "schema": {
              "type": "integer",
              "default": 20
            },
            "description": "Items per page (max 100)"
          }
        ],
        "responses": {
          "200": {
            "description": "User activity feed with pagination",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "activities": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/Activity"
                      }
                    },
                    "pagination": {
                      "type": "object",
                      "properties": {
                        "page": {
                          "type": "integer"
                        },
                        "limit": {
                          "type": "integer"
                        },
                        "total": {
                          "type": "integer"
                        },
                        "pages": {
                          "type": "integer"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Authentication required"
          }
        }
      }
    },
    "/activity/plan/{id}/activity": {
      "get": {
        "summary": "Get all activity logs for a plan",
        "tags": [
          "Activity"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The plan ID"
          },
          {
            "in": "query",
            "name": "page",
            "schema": {
              "type": "integer",
              "default": 1
            },
            "description": "Page number"
          },
          {
            "in": "query",
            "name": "limit",
            "schema": {
              "type": "integer",
              "default": 20
            },
            "description": "Items per page (max 100)"
          },
          {
            "in": "query",
            "name": "type",
            "schema": {
              "type": "string",
              "enum": [
                "progress",
                "reasoning",
                "challenge",
                "decision"
              ]
            },
            "description": "Filter by log type"
          }
        ],
        "responses": {
          "200": {
            "description": "Plan activity logs with pagination"
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "Plan not found"
          }
        }
      }
    },
    "/activity/plan/{id}/timeline": {
      "get": {
        "summary": "Get a chronological timeline of significant events for a plan",
        "tags": [
          "Activity"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The plan ID"
          }
        ],
        "responses": {
          "200": {
            "description": "Plan timeline"
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "Plan not found"
          }
        }
      }
    },
    "/activity/plan/{id}/nodes/{nodeId}/activity": {
      "get": {
        "summary": "Get recent activity for a specific node",
        "tags": [
          "Activity"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The plan ID"
          },
          {
            "in": "path",
            "name": "nodeId",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The node ID"
          },
          {
            "in": "query",
            "name": "limit",
            "schema": {
              "type": "integer",
              "default": 10
            },
            "description": "Maximum number of activities to return"
          }
        ],
        "responses": {
          "200": {
            "description": "Node activity"
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "Node not found"
          }
        }
      }
    },
    "/activity/plan/{id}/nodes/{nodeId}/detailed-log": {
      "post": {
        "summary": "Add a detailed activity log entry with metadata and tags",
        "tags": [
          "Activity"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The plan ID"
          },
          {
            "in": "path",
            "name": "nodeId",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The node ID"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "content"
                ],
                "properties": {
                  "content": {
                    "type": "string"
                  },
                  "log_type": {
                    "type": "string",
                    "enum": [
                      "progress",
                      "reasoning",
                      "challenge",
                      "decision"
                    ],
                    "default": "progress"
                  },
                  "metadata": {
                    "type": "object"
                  },
                  "tags": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Log entry added successfully"
          },
          "400": {
            "description": "Invalid input"
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "Node not found"
          }
        }
      }
    },
    "/plans/{id}/nodes/{nodeId}/artifacts": {
      "post": {
        "summary": "Add an artifact to a node",
        "tags": [
          "Artifacts"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The plan ID"
          },
          {
            "in": "path",
            "name": "nodeId",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The node ID"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "name",
                  "content_type",
                  "url"
                ],
                "properties": {
                  "name": {
                    "type": "string",
                    "description": "Name of the artifact"
                  },
                  "content_type": {
                    "type": "string",
                    "description": "MIME type or content type of the artifact"
                  },
                  "url": {
                    "type": "string",
                    "description": "URL or reference to the artifact content"
                  },
                  "metadata": {
                    "type": "object",
                    "description": "Additional metadata for the artifact"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Artifact added successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Artifact"
                }
              }
            }
          },
          "400": {
            "description": "Invalid input"
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "Node not found"
          }
        }
      },
      "get": {
        "summary": "List artifacts for a node",
        "tags": [
          "Artifacts"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The plan ID"
          },
          {
            "in": "path",
            "name": "nodeId",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The node ID"
          }
        ],
        "responses": {
          "200": {
            "description": "List of artifacts for the node",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "$ref": "#/components/schemas/Artifact"
                  }
                }
              }
            }
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "Node not found"
          }
        }
      }
    },
    "/plans/{id}/nodes/{nodeId}/artifacts/{artifactId}": {
      "get": {
        "summary": "Get a specific artifact",
        "tags": [
          "Artifacts"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The plan ID"
          },
          {
            "in": "path",
            "name": "nodeId",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The node ID"
          },
          {
            "in": "path",
            "name": "artifactId",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The artifact ID"
          }
        ],
        "responses": {
          "200": {
            "description": "Artifact details",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Artifact"
                }
              }
            }
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "Artifact not found"
          }
        }
      },
      "put": {
        "summary": "Update an artifact",
        "tags": [
          "Artifacts"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The plan ID"
          },
          {
            "in": "path",
            "name": "nodeId",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The node ID"
          },
          {
            "in": "path",
            "name": "artifactId",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The artifact ID"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "name": {
                    "type": "string",
                    "description": "Name of the artifact"
                  },
                  "content_type": {
                    "type": "string",
                    "description": "MIME type or content type of the artifact"
                  },
                  "url": {
                    "type": "string",
                    "description": "URL or reference to the artifact content"
                  },
                  "metadata": {
                    "type": "object",
                    "description": "Additional metadata for the artifact"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Artifact updated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Artifact"
                }
              }
            }
          },
          "400": {
            "description": "Invalid input"
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "Artifact not found"
          }
        }
      },
      "delete": {
        "summary": "Delete an artifact",
        "tags": [
          "Artifacts"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The plan ID"
          },
          {
            "in": "path",
            "name": "nodeId",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The node ID"
          },
          {
            "in": "path",
            "name": "artifactId",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The artifact ID"
          }
        ],
        "responses": {
          "204": {
            "description": "Artifact deleted successfully"
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "Artifact not found"
          }
        }
      }
    },
    "/plans/{id}/artifacts": {
      "get": {
        "summary": "List all artifacts across the plan",
        "tags": [
          "Artifacts"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The plan ID"
          }
        ],
        "responses": {
          "200": {
            "description": "List of all artifacts in the plan",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "$ref": "#/components/schemas/Artifact"
                  }
                }
              }
            }
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "Plan not found"
          }
        }
      }
    },
    "/api/artifacts/download": {
      "get": {
        "summary": "Download an artifact file",
        "tags": [
          "Artifacts"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "query",
            "name": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The file path to download"
          },
          {
            "in": "query",
            "name": "filename",
            "required": false,
            "schema": {
              "type": "string"
            },
            "description": "The filename to use for the download"
          }
        ],
        "responses": {
          "200": {
            "description": "File stream for download",
            "content": {
              "application/octet-stream": {
                "schema": {
                  "type": "string",
                  "format": "binary"
                }
              }
            }
          },
          "400": {
            "description": "Invalid path or not a file"
          },
          "401": {
            "description": "Authentication required"
          },
          "404": {
            "description": "File not found"
          }
        }
      }
    },
    "/auth/register": {
      "post": {
        "summary": "Register a new user",
        "tags": [
          "Authentication"
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "email",
                  "password"
                ],
                "properties": {
                  "email": {
                    "type": "string",
                    "format": "email"
                  },
                  "password": {
                    "type": "string",
                    "minLength": 6
                  },
                  "name": {
                    "type": "string"
                  },
                  "organization": {
                    "type": "string"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "User created successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "user": {
                      "type": "object",
                      "properties": {
                        "id": {
                          "type": "string"
                        },
                        "email": {
                          "type": "string"
                        },
                        "name": {
                          "type": "string"
                        },
                        "organization": {
                          "type": "string"
                        },
                        "email_verified": {
                          "type": "boolean"
                        }
                      }
                    },
                    "session": {
                      "type": "object",
                      "properties": {
                        "access_token": {
                          "type": "string"
                        },
                        "refresh_token": {
                          "type": "string"
                        },
                        "expires_at": {
                          "type": "number"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Invalid input"
          }
        }
      }
    },
    "/auth/login": {
      "post": {
        "summary": "Login and get authentication token",
        "tags": [
          "Authentication"
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "email",
                  "password"
                ],
                "properties": {
                  "email": {
                    "type": "string",
                    "format": "email"
                  },
                  "password": {
                    "type": "string"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Login successful",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "user": {
                      "type": "object",
                      "properties": {
                        "id": {
                          "type": "string"
                        },
                        "email": {
                          "type": "string"
                        },
                        "name": {
                          "type": "string"
                        },
                        "organization": {
                          "type": "string"
                        },
                        "email_verified": {
                          "type": "boolean"
                        }
                      }
                    },
                    "session": {
                      "type": "object",
                      "properties": {
                        "access_token": {
                          "type": "string"
                        },
                        "refresh_token": {
                          "type": "string"
                        },
                        "expires_at": {
                          "type": "number"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Authentication failed"
          }
        }
      }
    },
    "/auth/logout": {
      "post": {
        "summary": "Logout user",
        "tags": [
          "Authentication"
        ],
        "responses": {
          "200": {
            "description": "Logout successful",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "message": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/auth/forgot-password": {
      "post": {
        "summary": "Request password reset email",
        "tags": [
          "Authentication"
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "email"
                ],
                "properties": {
                  "email": {
                    "type": "string",
                    "format": "email"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Password reset email sent if account exists",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "message": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/auth/reset-password": {
      "post": {
        "summary": "Reset password with token",
        "tags": [
          "Authentication"
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "token",
                  "password"
                ],
                "properties": {
                  "token": {
                    "type": "string"
                  },
                  "password": {
                    "type": "string",
                    "minLength": 8
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Password successfully reset",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "message": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Invalid or expired token"
          }
        }
      }
    },
    "/auth/verify-email": {
      "post": {
        "summary": "Verify email with token",
        "tags": [
          "Authentication"
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "token"
                ],
                "properties": {
                  "token": {
                    "type": "string"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Email successfully verified",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "message": {
                      "type": "string"
                    },
                    "user": {
                      "type": "object"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Invalid or expired token"
          }
        }
      }
    },
    "/auth/resend-verification": {
      "post": {
        "summary": "Resend verification email",
        "tags": [
          "Authentication"
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "email"
                ],
                "properties": {
                  "email": {
                    "type": "string",
                    "format": "email"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Verification email sent if account exists",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "message": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/auth/profile": {
      "get": {
        "summary": "Get current user profile",
        "tags": [
          "Authentication"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "User profile retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "id": {
                      "type": "string"
                    },
                    "email": {
                      "type": "string"
                    },
                    "name": {
                      "type": "string"
                    },
                    "organization": {
                      "type": "string"
                    },
                    "avatar_url": {
                      "type": "string"
                    },
                    "email_verified": {
                      "type": "boolean"
                    },
                    "created_at": {
                      "type": "string",
                      "format": "date-time"
                    },
                    "updated_at": {
                      "type": "string",
                      "format": "date-time"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Authentication required"
          },
          "404": {
            "description": "User not found"
          }
        }
      },
      "put": {
        "summary": "Update user profile",
        "tags": [
          "Authentication"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "name": {
                    "type": "string"
                  },
                  "organization": {
                    "type": "string"
                  },
                  "avatar_url": {
                    "type": "string"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Profile updated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "id": {
                      "type": "string"
                    },
                    "email": {
                      "type": "string"
                    },
                    "name": {
                      "type": "string"
                    },
                    "organization": {
                      "type": "string"
                    },
                    "avatar_url": {
                      "type": "string"
                    },
                    "email_verified": {
                      "type": "boolean"
                    },
                    "created_at": {
                      "type": "string",
                      "format": "date-time"
                    },
                    "updated_at": {
                      "type": "string",
                      "format": "date-time"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Authentication required"
          },
          "404": {
            "description": "User not found"
          },
          "500": {
            "description": "Failed to update profile"
          }
        }
      }
    },
    "/auth/change-password": {
      "post": {
        "summary": "Change user password",
        "tags": [
          "Authentication"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "currentPassword",
                  "newPassword"
                ],
                "properties": {
                  "currentPassword": {
                    "type": "string"
                  },
                  "newPassword": {
                    "type": "string",
                    "minLength": 8
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Password changed successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "message": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Invalid input"
          },
          "401": {
            "description": "Current password incorrect or authentication required"
          },
          "404": {
            "description": "User not found"
          },
          "500": {
            "description": "Failed to update password"
          }
        }
      }
    },
    "/auth/token": {
      "post": {
        "summary": "Create an API token with specific scopes",
        "tags": [
          "Authentication"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "name"
                ],
                "properties": {
                  "name": {
                    "type": "string",
                    "description": "A name for the token"
                  },
                  "permissions": {
                    "type": "array",
                    "items": {
                      "type": "string",
                      "enum": [
                        "read",
                        "write",
                        "admin"
                      ]
                    },
                    "description": "Permission levels for the token"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Token created successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "id": {
                      "type": "string"
                    },
                    "name": {
                      "type": "string"
                    },
                    "token": {
                      "type": "string",
                      "description": "The API token (shown only once)"
                    },
                    "created_at": {
                      "type": "string",
                      "format": "date-time"
                    },
                    "permissions": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Authentication required"
          }
        }
      }
    },
    "/auth/token/{id}": {
      "delete": {
        "summary": "Revoke an API token",
        "tags": [
          "Authentication"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The token ID"
          }
        ],
        "responses": {
          "204": {
            "description": "Token revoked successfully"
          },
          "401": {
            "description": "Authentication required"
          },
          "404": {
            "description": "Token not found"
          }
        }
      }
    },
    "/debug/tokens": {
      "get": {
        "summary": "Debug endpoint to view all tokens for current user including revoked ones",
        "tags": [
          "Debug"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Token debug information"
          },
          "401": {
            "description": "Authentication required"
          }
        }
      }
    },
    "/plans/{id}/nodes": {
      "get": {
        "summary": "Get all nodes for a plan (tree structure)",
        "tags": [
          "Nodes"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The plan ID"
          }
        ],
        "responses": {
          "200": {
            "description": "Hierarchical tree of plan nodes",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "$ref": "#/components/schemas/Node"
                  }
                }
              }
            }
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "Plan not found"
          }
        }
      },
      "post": {
        "summary": "Create a new node in a plan",
        "tags": [
          "Nodes"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The plan ID"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "node_type",
                  "title"
                ],
                "properties": {
                  "parent_id": {
                    "type": "string",
                    "description": "Parent node ID (if not provided, will be assigned to the root node)"
                  },
                  "node_type": {
                    "type": "string",
                    "enum": [
                      "phase",
                      "task",
                      "milestone"
                    ]
                  },
                  "title": {
                    "type": "string"
                  },
                  "description": {
                    "type": "string"
                  },
                  "status": {
                    "type": "string",
                    "enum": [
                      "not_started",
                      "in_progress",
                      "completed",
                      "blocked"
                    ]
                  },
                  "order_index": {
                    "type": "integer"
                  },
                  "due_date": {
                    "type": "string",
                    "format": "date-time"
                  },
                  "context": {
                    "type": "string"
                  },
                  "agent_instructions": {
                    "type": "string"
                  },
                  "acceptance_criteria": {
                    "type": "string"
                  },
                  "metadata": {
                    "type": "object"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Node created successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Node"
                }
              }
            }
          },
          "400": {
            "description": "Invalid input"
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "Plan or parent node not found"
          }
        }
      }
    },
    "/plans/{id}/nodes/{nodeId}": {
      "get": {
        "summary": "Get a specific node",
        "tags": [
          "Nodes"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The plan ID"
          },
          {
            "in": "path",
            "name": "nodeId",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The node ID"
          }
        ],
        "responses": {
          "200": {
            "description": "Node details",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Node"
                }
              }
            }
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "Node not found"
          }
        }
      },
      "put": {
        "summary": "Update a node",
        "tags": [
          "Nodes"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The plan ID"
          },
          {
            "in": "path",
            "name": "nodeId",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The node ID"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "node_type": {
                    "type": "string",
                    "enum": [
                      "phase",
                      "task",
                      "milestone"
                    ]
                  },
                  "title": {
                    "type": "string"
                  },
                  "description": {
                    "type": "string"
                  },
                  "status": {
                    "type": "string",
                    "enum": [
                      "not_started",
                      "in_progress",
                      "completed",
                      "blocked"
                    ]
                  },
                  "order_index": {
                    "type": "integer"
                  },
                  "due_date": {
                    "type": "string",
                    "format": "date-time"
                  },
                  "context": {
                    "type": "string"
                  },
                  "agent_instructions": {
                    "type": "string"
                  },
                  "acceptance_criteria": {
                    "type": "string"
                  },
                  "metadata": {
                    "type": "object"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Node updated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Node"
                }
              }
            }
          },
          "400": {
            "description": "Invalid input"
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "Node not found"
          }
        }
      },
      "delete": {
        "summary": "Delete a node",
        "tags": [
          "Nodes"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The plan ID"
          },
          {
            "in": "path",
            "name": "nodeId",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The node ID"
          }
        ],
        "responses": {
          "204": {
            "description": "Node deleted successfully"
          },
          "400": {
            "description": "Cannot delete root node"
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "Node not found"
          }
        }
      }
    },
    "/plans/{id}/nodes/{nodeId}/comments": {
      "post": {
        "summary": "Add a comment to a node",
        "tags": [
          "Nodes"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The plan ID"
          },
          {
            "in": "path",
            "name": "nodeId",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The node ID"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "content"
                ],
                "properties": {
                  "content": {
                    "type": "string"
                  },
                  "comment_type": {
                    "type": "string",
                    "enum": [
                      "human",
                      "agent",
                      "system"
                    ],
                    "default": "human"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Comment added successfully"
          },
          "400": {
            "description": "Invalid input"
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "Node not found"
          }
        }
      },
      "get": {
        "summary": "Get comments for a node",
        "tags": [
          "Nodes"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The plan ID"
          },
          {
            "in": "path",
            "name": "nodeId",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The node ID"
          }
        ],
        "responses": {
          "200": {
            "description": "List of comments"
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "Node not found"
          }
        }
      }
    },
    "/plans/{id}/nodes/{nodeId}/context": {
      "get": {
        "summary": "Get detailed context for a specific node",
        "tags": [
          "Nodes"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The plan ID"
          },
          {
            "in": "path",
            "name": "nodeId",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The node ID"
          }
        ],
        "responses": {
          "200": {
            "description": "Detailed node context"
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "Node not found"
          }
        }
      }
    },
    "/plans/{id}/nodes/{nodeId}/ancestry": {
      "get": {
        "summary": "Get the path from root to this node with context",
        "tags": [
          "Nodes"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The plan ID"
          },
          {
            "in": "path",
            "name": "nodeId",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The node ID"
          }
        ],
        "responses": {
          "200": {
            "description": "Node ancestry path"
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "Node not found"
          }
        }
      }
    },
    "/plans/{id}/nodes/{nodeId}/status": {
      "put": {
        "summary": "Update the status of a node",
        "tags": [
          "Nodes"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The plan ID"
          },
          {
            "in": "path",
            "name": "nodeId",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The node ID"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "status"
                ],
                "properties": {
                  "status": {
                    "type": "string",
                    "enum": [
                      "not_started",
                      "in_progress",
                      "completed",
                      "blocked"
                    ]
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Status updated successfully"
          },
          "400": {
            "description": "Invalid input"
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "Node not found"
          }
        }
      }
    },
    "/plans/{id}/nodes/{nodeId}/move": {
      "post": {
        "summary": "Move a node to a different parent or position",
        "tags": [
          "Nodes"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The plan ID"
          },
          {
            "in": "path",
            "name": "nodeId",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The node ID"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "parent_id": {
                    "type": "string",
                    "description": "New parent node ID"
                  },
                  "order_index": {
                    "type": "integer",
                    "description": "New position among siblings"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Node moved successfully"
          },
          "400": {
            "description": "Invalid input or cannot move root node"
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "Node or parent not found"
          }
        }
      }
    },
    "/plans/{id}/nodes/{nodeId}/log": {
      "post": {
        "summary": "Add a progress log entry (for tracking agent activity)",
        "tags": [
          "Nodes"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The plan ID"
          },
          {
            "in": "path",
            "name": "nodeId",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The node ID"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "content"
                ],
                "properties": {
                  "content": {
                    "type": "string"
                  },
                  "log_type": {
                    "type": "string",
                    "enum": [
                      "progress",
                      "reasoning",
                      "challenge",
                      "decision"
                    ],
                    "default": "progress"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Log entry added successfully"
          },
          "400": {
            "description": "Invalid input"
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "Node not found"
          }
        }
      }
    },
    "/plans/{id}/nodes/{nodeId}/logs": {
      "get": {
        "summary": "Get activity logs for a node",
        "tags": [
          "Nodes"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The plan ID"
          },
          {
            "in": "path",
            "name": "nodeId",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The node ID"
          }
        ],
        "responses": {
          "200": {
            "description": "List of activity logs"
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "Node not found"
          }
        }
      }
    },
    "/plans": {
      "get": {
        "summary": "List all plans accessible to the user",
        "tags": [
          "Plans"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "A list of plans",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "$ref": "#/components/schemas/Plan"
                  }
                }
              }
            }
          },
          "401": {
            "description": "Authentication required"
          }
        }
      },
      "post": {
        "summary": "Create a new plan",
        "tags": [
          "Plans"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "title"
                ],
                "properties": {
                  "title": {
                    "type": "string"
                  },
                  "description": {
                    "type": "string"
                  },
                  "status": {
                    "type": "string",
                    "enum": [
                      "draft",
                      "active",
                      "completed",
                      "archived"
                    ]
                  },
                  "metadata": {
                    "type": "object"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Plan created successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Plan"
                }
              }
            }
          },
          "400": {
            "description": "Invalid input"
          },
          "401": {
            "description": "Authentication required"
          }
        }
      }
    },
    "/plans/{id}": {
      "get": {
        "summary": "Get a specific plan with its root node",
        "tags": [
          "Plans"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The plan ID"
          }
        ],
        "responses": {
          "200": {
            "description": "Plan details",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    {
                      "$ref": "#/components/schemas/Plan"
                    },
                    {
                      "type": "object",
                      "properties": {
                        "root_node": {
                          "type": "object",
                          "properties": {
                            "id": {
                              "type": "string"
                            },
                            "node_type": {
                              "type": "string"
                            },
                            "title": {
                              "type": "string"
                            },
                            "description": {
                              "type": "string"
                            },
                            "status": {
                              "type": "string"
                            },
                            "context": {
                              "type": "string"
                            }
                          }
                        }
                      }
                    }
                  ]
                }
              }
            }
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "Plan not found"
          }
        }
      },
      "put": {
        "summary": "Update a plan's properties",
        "tags": [
          "Plans"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The plan ID"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "title": {
                    "type": "string"
                  },
                  "description": {
                    "type": "string"
                  },
                  "status": {
                    "type": "string",
                    "enum": [
                      "draft",
                      "active",
                      "completed",
                      "archived"
                    ]
                  },
                  "metadata": {
                    "type": "object"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Plan updated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Plan"
                }
              }
            }
          },
          "400": {
            "description": "Invalid input"
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "Plan not found"
          }
        }
      },
      "delete": {
        "summary": "Delete a plan (or archive it)",
        "tags": [
          "Plans"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The plan ID"
          },
          {
            "in": "query",
            "name": "archive",
            "schema": {
              "type": "boolean"
            },
            "description": "If true, archive the plan instead of deleting it"
          }
        ],
        "responses": {
          "200": {
            "description": "Plan archived successfully (when archive=true)"
          },
          "204": {
            "description": "Plan deleted successfully"
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "Plan not found"
          }
        }
      }
    },
    "/plans/{id}/collaborators": {
      "get": {
        "summary": "List collaborators on a plan",
        "tags": [
          "Plans"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The plan ID"
          }
        ],
        "responses": {
          "200": {
            "description": "Collaborators list",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "owner": {
                      "type": "object",
                      "properties": {
                        "id": {
                          "type": "string"
                        },
                        "name": {
                          "type": "string"
                        },
                        "email": {
                          "type": "string"
                        }
                      }
                    },
                    "collaborators": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "id": {
                            "type": "string"
                          },
                          "user": {
                            "type": "object",
                            "properties": {
                              "id": {
                                "type": "string"
                              },
                              "name": {
                                "type": "string"
                              },
                              "email": {
                                "type": "string"
                              }
                            }
                          },
                          "role": {
                            "type": "string"
                          },
                          "created_at": {
                            "type": "string",
                            "format": "date-time"
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "Plan not found"
          }
        }
      },
      "post": {
        "summary": "Add a collaborator to a plan",
        "tags": [
          "Plans"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The plan ID"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "email",
                  "role"
                ],
                "properties": {
                  "email": {
                    "type": "string",
                    "format": "email"
                  },
                  "role": {
                    "type": "string",
                    "enum": [
                      "viewer",
                      "editor",
                      "admin"
                    ]
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Collaborator role updated successfully"
          },
          "201": {
            "description": "Collaborator added successfully"
          },
          "400": {
            "description": "Invalid input"
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "User or plan not found"
          }
        }
      }
    },
    "/plans/{id}/collaborators/{userId}": {
      "delete": {
        "summary": "Remove a collaborator from a plan",
        "tags": [
          "Plans"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The plan ID"
          },
          {
            "in": "path",
            "name": "userId",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The user ID to remove"
          }
        ],
        "responses": {
          "204": {
            "description": "Collaborator removed successfully"
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "Plan or collaborator not found"
          }
        }
      }
    },
    "/plans/{id}/context": {
      "get": {
        "summary": "Get a compiled context of the entire plan suitable for agents",
        "tags": [
          "Plans"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The plan ID"
          }
        ],
        "responses": {
          "200": {
            "description": "Plan context",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "plan": {
                      "$ref": "#/components/schemas/Plan"
                    },
                    "structure": {
                      "type": "object",
                      "description": "Hierarchical structure of nodes"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "Plan not found"
          }
        }
      }
    },
    "/plans/{id}/progress": {
      "get": {
        "summary": "Get progress statistics for a plan",
        "tags": [
          "Plans"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The plan ID"
          }
        ],
        "responses": {
          "200": {
            "description": "Plan progress statistics",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "progress": {
                      "type": "integer",
                      "description": "Progress percentage (0-100)"
                    },
                    "totalNodes": {
                      "type": "integer",
                      "description": "Total number of nodes in the plan"
                    },
                    "completedNodes": {
                      "type": "integer",
                      "description": "Number of completed nodes"
                    },
                    "inProgress": {
                      "type": "integer",
                      "description": "Number of nodes in progress"
                    },
                    "notStarted": {
                      "type": "integer",
                      "description": "Number of nodes not started"
                    },
                    "blocked": {
                      "type": "integer",
                      "description": "Number of blocked nodes"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "Plan not found"
          },
          "500": {
            "description": "Failed to calculate progress"
          }
        }
      }
    },
    "/search": {
      "get": {
        "summary": "Global search across all accessible resources",
        "tags": [
          "Search"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "query",
            "name": "query",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "Search term (min 3 characters)"
          }
        ],
        "responses": {
          "200": {
            "description": "Search results across all resources",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "query": {
                      "type": "string"
                    },
                    "results": {
                      "type": "object",
                      "properties": {
                        "plans": {
                          "type": "array",
                          "items": {
                            "type": "object"
                          }
                        },
                        "nodes": {
                          "type": "array",
                          "items": {
                            "type": "object"
                          }
                        },
                        "comments": {
                          "type": "array",
                          "items": {
                            "type": "object"
                          }
                        },
                        "logs": {
                          "type": "array",
                          "items": {
                            "type": "object"
                          }
                        },
                        "artifacts": {
                          "type": "array",
                          "items": {
                            "type": "object"
                          }
                        }
                      }
                    },
                    "counts": {
                      "type": "object",
                      "properties": {
                        "plans": {
                          "type": "integer"
                        },
                        "nodes": {
                          "type": "integer"
                        },
                        "comments": {
                          "type": "integer"
                        },
                        "logs": {
                          "type": "integer"
                        },
                        "artifacts": {
                          "type": "integer"
                        },
                        "total": {
                          "type": "integer"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Invalid query"
          },
          "401": {
            "description": "Authentication required"
          }
        }
      }
    },
    "/plans/{id}/nodes/search": {
      "get": {
        "summary": "Search for nodes in a specific plan with filtering",
        "tags": [
          "Search"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The plan ID"
          },
          {
            "in": "query",
            "name": "query",
            "schema": {
              "type": "string"
            },
            "description": "Search term (minimum 3 characters)"
          },
          {
            "in": "query",
            "name": "status",
            "schema": {
              "type": "string"
            },
            "description": "Filter by status (comma-separated for multiple values)"
          },
          {
            "in": "query",
            "name": "node_type",
            "schema": {
              "type": "string"
            },
            "description": "Filter by node type (comma-separated for multiple values)"
          },
          {
            "in": "query",
            "name": "date_from",
            "schema": {
              "type": "string",
              "format": "date"
            },
            "description": "Filter by creation date (from)"
          },
          {
            "in": "query",
            "name": "date_to",
            "schema": {
              "type": "string",
              "format": "date"
            },
            "description": "Filter by creation date (to)"
          }
        ],
        "responses": {
          "200": {
            "description": "Search results for nodes in the plan"
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "Plan not found"
          }
        }
      }
    },
    "/artifacts/search": {
      "get": {
        "summary": "Search for artifacts across all accessible plans",
        "tags": [
          "Search"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "query",
            "name": "query",
            "schema": {
              "type": "string"
            },
            "description": "Search term"
          },
          {
            "in": "query",
            "name": "content_type",
            "schema": {
              "type": "string"
            },
            "description": "Filter by content type (comma-separated for multiple values)"
          }
        ],
        "responses": {
          "200": {
            "description": "Search results for artifacts"
          },
          "401": {
            "description": "Authentication required"
          }
        }
      }
    },
    "/search/plan/{plan_id}": {
      "get": {
        "summary": "Search within a plan using the database search function",
        "tags": [
          "Search"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "plan_id",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid"
            },
            "description": "ID of the plan to search within"
          },
          {
            "in": "query",
            "name": "query",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "Search query text (min 2 characters)"
          }
        ],
        "responses": {
          "200": {
            "description": "Search results within the plan",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "query": {
                      "type": "string",
                      "description": "The original search query"
                    },
                    "results": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "id": {
                            "type": "string",
                            "format": "uuid"
                          },
                          "type": {
                            "type": "string",
                            "enum": [
                              "node",
                              "comment",
                              "log",
                              "artifact"
                            ]
                          },
                          "title": {
                            "type": "string"
                          },
                          "content": {
                            "type": "string"
                          },
                          "created_at": {
                            "type": "string",
                            "format": "date-time"
                          },
                          "user_id": {
                            "type": "string",
                            "format": "uuid"
                          }
                        }
                      }
                    },
                    "count": {
                      "type": "integer",
                      "description": "Total number of results"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Invalid query"
          },
          "401": {
            "description": "Authentication required"
          },
          "403": {
            "description": "Access denied"
          },
          "404": {
            "description": "Plan not found"
          },
          "500": {
            "description": "Server error"
          }
        }
      }
    },
    "/tokens": {
      "get": {
        "summary": "List all API tokens for the current user",
        "tags": [
          "API Tokens"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "List of tokens",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": {
                    "$ref": "#/components/schemas/Token"
                  }
                }
              }
            }
          },
          "401": {
            "description": "Authentication required"
          }
        }
      },
      "post": {
        "summary": "Create a new API token",
        "tags": [
          "API Tokens"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "name"
                ],
                "properties": {
                  "name": {
                    "type": "string",
                    "description": "A descriptive name for the token"
                  },
                  "permissions": {
                    "type": "array",
                    "items": {
                      "type": "string",
                      "enum": [
                        "read",
                        "write",
                        "admin"
                      ]
                    },
                    "default": [
                      "read"
                    ]
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Token created successfully",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    {
                      "$ref": "#/components/schemas/Token"
                    },
                    {
                      "type": "object",
                      "properties": {
                        "token": {
                          "type": "string",
                          "description": "The actual token value (displayed only once)"
                        }
                      }
                    }
                  ]
                }
              }
            }
          },
          "400": {
            "description": "Invalid input"
          },
          "401": {
            "description": "Authentication required"
          }
        }
      }
    },
    "/tokens/{id}": {
      "delete": {
        "summary": "Revoke an API token",
        "tags": [
          "API Tokens"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "in": "path",
            "name": "id",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "The token ID to revoke"
          }
        ],
        "responses": {
          "204": {
            "description": "Token revoked successfully"
          },
          "401": {
            "description": "Authentication required"
          },
          "404": {
            "description": "Token not found"
          }
        }
      }
    },
    "/upload/avatar": {
      "post": {
        "summary": "Upload user avatar",
        "tags": [
          "Upload"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "multipart/form-data": {
              "schema": {
                "type": "object",
                "properties": {
                  "avatar": {
                    "type": "string",
                    "format": "binary",
                    "description": "Avatar image file (JPEG, PNG, GIF, or WebP)"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Avatar uploaded successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "message": {
                      "type": "string"
                    },
                    "avatar_url": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Invalid file or no file uploaded"
          },
          "401": {
            "description": "Authentication required"
          },
          "500": {
            "description": "Upload failed"
          }
        }
      },
      "delete": {
        "summary": "Delete user avatar",
        "tags": [
          "Upload"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Avatar deleted successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "message": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Authentication required"
          },
          "404": {
            "description": "No avatar to delete"
          },
          "500": {
            "description": "Deletion failed"
          }
        }
      }
    },
    "/users/profile": {
      "get": {
        "summary": "Get current user profile",
        "tags": [
          "User"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "User profile retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "id": {
                      "type": "string"
                    },
                    "email": {
                      "type": "string"
                    },
                    "name": {
                      "type": "string"
                    },
                    "organization": {
                      "type": "string"
                    },
                    "avatar_url": {
                      "type": "string"
                    },
                    "email_verified": {
                      "type": "boolean"
                    },
                    "created_at": {
                      "type": "string",
                      "format": "date-time"
                    },
                    "updated_at": {
                      "type": "string",
                      "format": "date-time"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Authentication required"
          },
          "404": {
            "description": "User not found"
          }
        }
      },
      "put": {
        "summary": "Update user profile",
        "tags": [
          "User"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "name": {
                    "type": "string"
                  },
                  "organization": {
                    "type": "string"
                  },
                  "avatar_url": {
                    "type": "string"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Profile updated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "id": {
                      "type": "string"
                    },
                    "email": {
                      "type": "string"
                    },
                    "name": {
                      "type": "string"
                    },
                    "organization": {
                      "type": "string"
                    },
                    "avatar_url": {
                      "type": "string"
                    },
                    "email_verified": {
                      "type": "boolean"
                    },
                    "created_at": {
                      "type": "string",
                      "format": "date-time"
                    },
                    "updated_at": {
                      "type": "string",
                      "format": "date-time"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Invalid input"
          },
          "401": {
            "description": "Authentication required"
          },
          "404": {
            "description": "User not found"
          },
          "500": {
            "description": "Failed to update profile"
          }
        }
      }
    },
    "/users/change-password": {
      "post": {
        "summary": "Change user password",
        "tags": [
          "User"
        ],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "currentPassword",
                  "newPassword"
                ],
                "properties": {
                  "currentPassword": {
                    "type": "string"
                  },
                  "newPassword": {
                    "type": "string",
                    "minLength": 8
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Password changed successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "message": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Invalid input"
          },
          "401": {
            "description": "Current password incorrect or authentication required"
          },
          "404": {
            "description": "User not found"
          },
          "500": {
            "description": "Failed to update password"
          }
        }
      }
    }
  }
}